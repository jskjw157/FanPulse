spring:
  application:
    name: fanpulse-backend

  datasource:
    url: jdbc:postgresql://${DB_HOST:localhost}:${DB_PORT:5432}/${DB_NAME:fanpulse}
    username: ${DB_USERNAME}
    password: ${DB_PASSWORD}
    driver-class-name: org.postgresql.Driver

  jpa:
    hibernate:
      ddl-auto: validate
    show-sql: false
    properties:
      hibernate:
        format_sql: true
        dialect: org.hibernate.dialect.PostgreSQLDialect

  flyway:
    enabled: true
    baseline-on-migrate: true
    baseline-version: 0
    locations: classpath:db/migration
    validate-on-migrate: true
    out-of-order: false
    clean-disabled: true

fanpulse:
  jwt:
    secret: ${JWT_SECRET}
    access-expiration: 3600000      # 1 hour in milliseconds
    refresh-expiration: 604800000   # 7 days in milliseconds

  google:
    client-id: ${GOOGLE_CLIENT_ID}

  youtube:
    oembed:
      base-url: https://www.youtube.com/oembed
      timeout-ms: 5000
      retry:
        max-attempts: 3
        delay-ms: 1000

  discovery:
    ytdlp:
      command: yt-dlp
      timeout-ms: 30000   # 30초 타임아웃
      playlist-limit: 30   # 채널당 30개
      extract-flat: false

  scheduler:
    metadata-refresh:
      enabled: true
      live-cron: "0 0 * * * *"
      all-cron: "0 0 0 * * *"
      batch-size: 50
      batch-delay-ms: 1000
    live-discovery:
      enabled: true
      cron: "0 0 * * * *"  # 매시간 실행
      channel-delay-ms: 500
      max-concurrency: 5

# Resilience4j Circuit Breaker
resilience4j:
  circuitbreaker:
    instances:
      youtubeOEmbed:
        registerHealthIndicator: true
        slidingWindowType: COUNT_BASED
        slidingWindowSize: 10
        minimumNumberOfCalls: 5
        failureRateThreshold: 50
        waitDurationInOpenState: 30s
        permittedNumberOfCallsInHalfOpenState: 3
        automaticTransitionFromOpenToHalfOpenEnabled: true
        recordExceptions:
          - java.io.IOException
          - java.util.concurrent.TimeoutException
          - org.springframework.web.reactive.function.client.WebClientResponseException.ServiceUnavailable
          - org.springframework.web.reactive.function.client.WebClientResponseException.GatewayTimeout
          - com.fanpulse.infrastructure.external.youtube.QuotaExceededException
          - com.fanpulse.infrastructure.external.youtube.UnexpectedClientException
        ignoreExceptions:
          - com.fanpulse.infrastructure.external.youtube.VideoNotFoundException
          - com.fanpulse.infrastructure.external.youtube.RateLimitExceededException

      # P0-2: yt-dlp Circuit Breaker 설정
      ytdlp:
        registerHealthIndicator: true
        slidingWindowType: COUNT_BASED
        slidingWindowSize: 10
        minimumNumberOfCalls: 5
        failureRateThreshold: 50
        waitDurationInOpenState: 60s
        permittedNumberOfCallsInHalfOpenState: 3
        automaticTransitionFromOpenToHalfOpenEnabled: true
        recordExceptions:
          - java.lang.IllegalStateException
          - java.io.IOException
          - java.util.concurrent.TimeoutException

  # P0-2: Retry 설정
  retry:
    instances:
      ytdlp:
        maxAttempts: 3
        waitDuration: 2s
        enableExponentialBackoff: true
        exponentialBackoffMultiplier: 2
        retryExceptions:
          - java.lang.IllegalStateException
          - java.io.IOException

management:
  endpoints:
    web:
      exposure:
        include: health,metrics,circuitbreakers,prometheus
  endpoint:
    health:
      show-details: always
  health:
    circuitbreakers:
      enabled: true

logging:
  level:
    com.fanpulse: DEBUG
    org.springframework.web: INFO
